from typing import Dict, Union

import pandas as pd
from numpy import typing as npt

from cogeneration.type.str_enum import StrEnum


class MetadataColumn(StrEnum):
    """Columns in the training/synthetic/redesign/test metadata CSVs"""

    pdb_name = "pdb_name"
    # (optional) original PDB file
    raw_path = "raw_path"
    # pkl file for processed structure/sequence
    processed_path = "processed_path"
    quaternary_category = "quaternary_category"
    # num non-unique sequences
    oligomeric_count = "oligomeric_count"
    # per-unique seq details
    oligomeric_detail = "oligomeric_detail"
    # number of chains in protein (ignores non-residue chains)
    num_chains = "num_chains"
    # total number of residues
    seq_len = "seq_len"
    # (new) count of num residues in modeled structure, not including gaps
    moduled_num_res = "moduled_num_res"
    # modeled residues, whole complex trimming (i.e. max - min res number)
    modeled_seq_len = "modeled_seq_len"
    # (new) modeled residues, chains independently trimmed
    modeled_indep_seq_len = "modeled_indep_seq_len"
    # secondary structure stats
    coil_percent = "coil_percent"
    helix_percent = "helix_percent"
    strand_percent = "strand_percent"
    radius_gyration = "radius_gyration"

    # TODO add in process_pdb_files if provided
    resolution = "resolution"
    structure_method = "structure_method"

    # cluster metadata (added by loading clusters csv)
    cluster = "cluster"

    # redesign columns
    example = "example"
    best_seq = "best_seq"  # best 1 redesign per structure
    best_rmsd = "best_rmsd"

    # added during load
    index = "index"


class DatasetProteinColumn(StrEnum):
    """
    Information about the protein, pickled in `processed_path`, or from parsing a Protein / Chain.
    Most of these values are defined by `process_chain` and `parse_chain_feats`.
    A few (like `bb_mask` and `bb_positions` are added during processing).
    Only protein chains are saved in the ProcessedFile.

    The saved proteins contain all molecules / residues, and is of length P.
    `modeled_idx` is length N, and defines which residues are modeled.
    It is used to select windows of the structure, then dropped in loading i.e. `read_processed_file()`.
    Also note that during loading, the structure is centered and re-indexed, so many of these values change.
    """

    aatype = "aatype"  # (P, ) AA sequence residue indices
    atom_mask = "atom_mask"  # (P, 37) all atoms to consider
    bb_mask = "bb_mask"  # (P, ) alpha carbons considered
    atom_positions = "atom_positions"  # (P, 37, 3) all atom positions
    bb_positions = "bb_positions"  # (P, 3) alpha carbon
    residue_index = "residue_index"  # (P, ) residue index
    chain_index = "chain_index"  # (P, ) chain index
    b_factors = "b_factors"  # (P, 37) b factors
    modeled_idx = "modeled_idx"  # (N, ) index of modeled residues


class DatasetTransformColumn(StrEnum):
    """
    Columns generated by OpenFold data transform
    """

    # atom37_to_frames()
    rigidgroups_gt_frames = "rigidgroups_gt_frames"
    rigidgroups_gt_exists = "rigidgroups_gt_exists"
    rigidgroups_group_exists = "rigidgroups_group_exists"
    rigidgroups_group_is_ambiguous = "rigidgroups_group_is_ambiguous"
    rigidgroups_alt_gt_frames = "rigidgroups_alt_gt_frames"
    # atom37_to_torsion_angles()
    torsion_angles_sin_cos = "torsion_angles_sin_cos"


"""NumpyPrimitiveFeat is a feature in primitive or numpy"""
NumpyPrimitiveFeat = Union[npt.NDArray, str, int]

"""MetadataCSVRow type alias for a single row of the metadata CSV file"""
MetadataCSVRow = Dict[MetadataColumn, NumpyPrimitiveFeat]

"""MetadataDataFrame type alias for the metadata CSV file, composed of MetadataCSVRow"""
MetadataDataFrame = pd.DataFrame

"""
ChainFeatures represents an intermediate state converting `asdict(Protein)` to `ProcessedFile`.
Use when only a subset of fields of `DatasetProteinColumns` are present in `ChainFeatures`.
"""
ChainFeatures = Dict[DatasetProteinColumn, npt.NDArray]

"""
ProcessedFile for pre-processed pkl, produced by `parse_pdb_files.py`
It contains 1+ chains, concatenated into a flat `chain_features`.
"""
ProcessedFile = Dict[DatasetProteinColumn, npt.NDArray]


"""
Note the descriptions vary more widely in the metadata provided by MultiFlow,
perhaps taken from PDB directly, but this is fairly close.
"""
OLIGOMERIC_PREFIXES = {
    1: "mono",
    2: "di",
    3: "tri",
    4: "tetra",
    5: "penta",
    6: "hexa",
    7: "hepta",
    8: "octa",
    9: "nona",
    10: "deca",
    11: "undeca",
    12: "dodeca",  # pref to `duodeca`
    13: "trideca",
    14: "tetradeca",
    15: "pentadeca",
    16: "hexadeca",
    17: "heptadeca",
    18: "octadeca",
    19: "nonadeca",
    20: "eicosa",  # pref to `icosa`
}
